name: Scheduled Scrape

on:
  workflow_dispatch:
  schedule:
    # # CRITICAL CHANGE: Run every 15 minutes (at the 0, 15, 30, and 45-minute mark of every hour)
    - cron: '*/15 * * * *'

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # --- CRITICAL FIX: The `env` variables are now mapped to the names expected by index.js ---
    env:
      # CRITICAL FIX 1: Remapping the URL name. 
      # Your index.js checks for JOBS_PAGE_URL, so we must map your secret (SCRAPE_URL) to that name.
      JOBS_PAGE_URL: ${{ secrets.JOBS_PAGE_URL }} 
      
      FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
      
      # FIX 2 (Telegram Warning): The index.js code expects TELEGRAM_TOKEN, not TELEGRAM_BOT_TOKEN
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      # The index.js code also expects these, even if they are empty
      WEBSITE_USERNAME: ${{ secrets.WEBSITE_USERNAME }}
      WEBSITE_PASSWORD: ${{ secrets.WEBSITE_PASSWORD }}

      # Optional selectors overrides
      # LIST_CONTAINER_SELECTOR: '.results'
      # ITEM_ROW_SELECTOR: '.job-row'
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run scraper
        run: node index.js

      - name: üö® Notify on Workflow Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ö†Ô∏è **WORKFLOW CRITICAL FAILURE** ‚ö†Ô∏è
            
            *Job:* Scraper Alpha-7
            *Reason:* Scraper crashed or hit 10-minute timeout.
            *View Logs:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
