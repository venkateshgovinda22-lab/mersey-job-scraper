name: Mercy Medical Scraper

# Concurrency ensures only one scraper runs at a time. 
concurrency: 
  group: scraper-production
  cancel-in-progress: false

on:
  schedule:
    # 1. PEAK HOURS (Mon-Fri): Every 15 minutes
    - cron: '*/15 6-21 * * 1-5'
    
    # 2. OFF-PEAK (Mon-Fri Nights): Every Hour
    - cron: '0 22-5 * * 1-5'

    # 3. WEEKENDS: Every Hour
    - cron: '0 8-22 * * 6,0'

  # Allows manual testing
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    # CRITICAL: Hard stop after 10 minutes.
    timeout-minutes: 10 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Run Scraper
        id: run_scraper_step # Give this step an ID to reference
        env:
          WEBSITE_USERNAME: ${{ secrets.WEBSITE_USERNAME }}
          WEBSITE_PASSWORD: ${{ secrets.WEBSITE_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
          JOBS_PAGE_URL: ${{ secrets.JOBS_PAGE_URL }} 
        # The '|| exit 0' prevents the overall job from failing if the script fails, 
        # which lets the final notification step run properly.
        run: node index.js || exit 0 
      
      - name: üö® Notify on Workflow Failure (Final Check)
        # This step runs if the previous steps failed OR if the overall job times out.
        # It ensures you get a notification even if index.js didn't start its own error logic.
        if: ${{ failure() || cancelled() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ö†Ô∏è **WORKFLOW CRITICAL FAILURE** ‚ö†Ô∏è
            
            *Job:* ${{ github.workflow }}
            *Status:* Failed/Timeout (Exceeded 10 mins)
            *Repo:* ${{ github.repository }}
            *Check Logs:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          disable_web_page_preview: true
