name: Mercy Medical Scraper

# Concurrency ensures only one scraper runs at a time. 
concurrency: 
  group: scraper-production
  cancel-in-progress: false

on:
  schedule:
    # 1. PEAK HOURS (Mon-Fri): Every 15 minutes
    #    06:00 to 21:00 UTC
    - cron: '*/15 6-21 * * 1-5'
    
    # 2. OFF-PEAK (Mon-Fri Nights): Every Hour
    #    GitHub Fix: Split '22-5' into two separate lines
    - cron: '0 22-23 * * 1-5'  # 10 PM and 11 PM
    - cron: '0 0-5 * * 1-5'    # Midnight to 5 AM

    # 3. WEEKENDS: Every Hour
    #    08:00 to 22:00 UTC
    - cron: '0 8-22 * * 6,0'

  # Allows manual testing
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    # CRITICAL: Hard stop after 10 minutes.
    timeout-minutes: 10 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm install

      - name: Run Scraper
        id: run_scraper_step
        env:
          WEBSITE_USERNAME: ${{ secrets.WEBSITE_USERNAME }}
          WEBSITE_PASSWORD: ${{ secrets.WEBSITE_PASSWORD }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
          JOBS_PAGE_URL: ${{ secrets.JOBS_PAGE_URL }} 
        # We let this step fail naturally so the next step detects it
        run: node index.js
      
      - name: üö® Notify on Workflow Failure
        # This step ONLY runs if the 'Run Scraper' step failed or timed out
        if: failure() 
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ö†Ô∏è **WORKFLOW CRITICAL FAILURE** ‚ö†Ô∏è
            
            *Job:* ${{ github.workflow }}
            *Reason:* Scraper crashed or hit 10-minute timeout.
            *Repo:* ${{ github.repository }}
            *Check Logs:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          disable_web_page_preview: true
